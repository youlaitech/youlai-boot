# å¤šç§Ÿæˆ·è¡¨éš”ç¦»ç­–ç•¥è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜ç³»ç»Ÿä¸­å„ä¸šåŠ¡è¡¨çš„å¤šç§Ÿæˆ·éš”ç¦»ç­–ç•¥ï¼Œå¸®åŠ©ç†è§£å“ªäº›è¡¨éœ€è¦ç§Ÿæˆ·éš”ç¦»ï¼Œå“ªäº›è¡¨åº”è¯¥å…±äº«ã€‚

---

## ğŸ¯ è®¾è®¡åŸåˆ™

### 1. **æ•°æ®éš”ç¦»**ï¼ˆTenant Isolationï¼‰
- ç§Ÿæˆ·ç§æœ‰æ•°æ®å¿…é¡»ä¸¥æ ¼éš”ç¦»
- é€šè¿‡ `tenant_id` å­—æ®µå®ç°
- MyBatis-Plus å¤šç§Ÿæˆ·æ’ä»¶è‡ªåŠ¨æ·»åŠ è¿‡æ»¤æ¡ä»¶

### 2. **åŠŸèƒ½å…±äº«**ï¼ˆFeature Sharingï¼‰
- ç³»ç»ŸåŠŸèƒ½å®šä¹‰åº”è¯¥æ ‡å‡†åŒ–
- é¿å…é‡å¤æ•°æ®å’Œç»´æŠ¤æˆæœ¬
- é€šè¿‡è§’è‰²å’Œæƒé™æ§åˆ¶è®¿é—®

### 3. **çµæ´»é…ç½®**ï¼ˆFlexible Configurationï¼‰
- é€šè¿‡é…ç½®æ–‡ä»¶æ§åˆ¶éš”ç¦»ç­–ç•¥
- å¯éšæ—¶è°ƒæ•´éš”ç¦»èŒƒå›´
- é›¶æˆæœ¬åˆ‡æ¢å•ç§Ÿæˆ·/å¤šç§Ÿæˆ·

---

## ğŸ“Š è¡¨éš”ç¦»ç­–ç•¥

### âœ… éœ€è¦ç§Ÿæˆ·éš”ç¦»çš„è¡¨

è¿™äº›è¡¨å­˜å‚¨ç§Ÿæˆ·ç§æœ‰æ•°æ®ï¼Œå¿…é¡»æ·»åŠ  `tenant_id` å­—æ®µï¼š

| è¡¨å | è¯´æ˜ | éš”ç¦»åŸå›  |
|------|------|---------|
| `sys_user` | ç”¨æˆ·è¡¨ | ç”¨æˆ·å±äºç‰¹å®šç§Ÿæˆ·ï¼Œæ•°æ®å¿…é¡»éš”ç¦» |
| `sys_role` | è§’è‰²è¡¨ | è§’è‰²æ˜¯ç§Ÿæˆ·è‡ªå®šä¹‰çš„ï¼Œä¸åŒç§Ÿæˆ·è§’è‰²ä¸åŒ |
| `sys_dept` | éƒ¨é—¨è¡¨ | éƒ¨é—¨ç»“æ„æ˜¯ç§Ÿæˆ·ç§æœ‰çš„ç»„ç»‡æ¶æ„ |
| `sys_notice` | é€šçŸ¥å…¬å‘Šè¡¨ | é€šçŸ¥æ˜¯ç§Ÿæˆ·å†…éƒ¨çš„ä¿¡æ¯ |
| `sys_log` | ç³»ç»Ÿæ—¥å¿—è¡¨ | æ—¥å¿—è®°å½•ç§Ÿæˆ·çš„æ“ä½œè¡Œä¸º |
| `sys_role_menu` | è§’è‰²èœå•å…³è”è¡¨ | è§’è‰²æ˜¯ç§Ÿæˆ·éš”ç¦»çš„ï¼Œå…³è”è¡¨ä¹Ÿéœ€è¦éš”ç¦» |
| `sys_user_role` | ç”¨æˆ·è§’è‰²å…³è”è¡¨ | ç”¨æˆ·å’Œè§’è‰²éƒ½æ˜¯ç§Ÿæˆ·éš”ç¦»çš„ |
| `ai_command_record` | AIå‘½ä»¤è®°å½•è¡¨ | å‘½ä»¤è®°å½•æ˜¯ç§Ÿæˆ·ç§æœ‰æ•°æ® |

**å®ç°æ–¹å¼**ï¼š
```sql
-- æ·»åŠ  tenant_id å­—æ®µ
ALTER TABLE `sys_user` 
ADD COLUMN `tenant_id` bigint DEFAULT 1 COMMENT 'ç§Ÿæˆ·ID' AFTER `id`,
ADD INDEX `idx_tenant_id` (`tenant_id`);

-- åˆå§‹åŒ–ä¸ºé»˜è®¤ç§Ÿæˆ·
UPDATE `sys_user` SET `tenant_id` = 1 WHERE `tenant_id` IS NULL;
```

---

### âŒ ä¸éœ€è¦ç§Ÿæˆ·éš”ç¦»çš„è¡¨

è¿™äº›è¡¨å­˜å‚¨ç³»ç»Ÿå…¬å…±æ•°æ®ï¼Œåº”è¯¥æ‰€æœ‰ç§Ÿæˆ·å…±äº«ï¼š

| è¡¨å | è¯´æ˜ | å…±äº«åŸå›  |
|------|------|---------|
| `sys_tenant` | ç§Ÿæˆ·è¡¨ | ç§Ÿæˆ·è¡¨æœ¬èº«ä¸èƒ½éš”ç¦» |
| **`sys_menu`** | **èœå•è¡¨** | **åŠŸèƒ½å…¥å£å®šä¹‰ï¼Œæ ‡å‡†åŒ–å…±äº«** |
| `sys_dict` | å­—å…¸è¡¨ | ç³»ç»Ÿå­—å…¸é€šå¸¸æ˜¯æ ‡å‡†åŒ–çš„ |
| `sys_dict_item` | å­—å…¸é¡¹è¡¨ | å­—å…¸å€¼åº”è¯¥ç»Ÿä¸€ |
| `sys_config` | ç³»ç»Ÿé…ç½®è¡¨ | ç³»ç»Ÿçº§é…ç½®åº”è¯¥å…¨å±€ç»Ÿä¸€ |

**é…ç½®æ–¹å¼**ï¼š
```yaml
youlai:
  tenant:
    enabled: true
    ignore-tables:
      - sys_tenant      # ç§Ÿæˆ·è¡¨æœ¬èº«
      - sys_menu        # èœå•è¡¨ï¼ˆé‡ç‚¹ï¼ï¼‰
      - sys_dict        # å­—å…¸è¡¨
      - sys_dict_item   # å­—å…¸é¡¹è¡¨
      - sys_config      # ç³»ç»Ÿé…ç½®è¡¨
```

---

## ğŸ” é‡ç‚¹è¯´æ˜ï¼šä¸ºä»€ä¹ˆèœå•ä¸éš”ç¦»ï¼Ÿ

### é—®é¢˜èƒŒæ™¯
```sql
-- é”™è¯¯ç¤ºä¾‹ï¼šå¦‚æœèœå•éš”ç¦»ï¼Œä¼šäº§ç”Ÿå¤§é‡å†—ä½™
ç§Ÿæˆ·Açš„èœå•ï¼š
  - ç³»ç»Ÿç®¡ç† â†’ ç”¨æˆ·ç®¡ç† â†’ è§’è‰²ç®¡ç†
ç§Ÿæˆ·Bçš„èœå•ï¼š
  - ç³»ç»Ÿç®¡ç† â†’ ç”¨æˆ·ç®¡ç† â†’ è§’è‰²ç®¡ç†
ç§Ÿæˆ·Cçš„èœå•ï¼š
  - ç³»ç»Ÿç®¡ç† â†’ ç”¨æˆ·ç®¡ç† â†’ è§’è‰²ç®¡ç†
ï¼ˆå®Œå…¨ç›¸åŒçš„èœå•å®šä¹‰é‡å¤äº†3æ¬¡ï¼ï¼‰
```

### æ¨èæ–¹æ¡ˆï¼šèœå•å…±äº« + è§’è‰²æ§åˆ¶

#### 1. **èœå•å®šä¹‰å…±äº«**
```
æ‰€æœ‰ç§Ÿæˆ·å…±äº«åŒä¸€å¥—èœå•å®šä¹‰ï¼š
â”œâ”€ ç³»ç»Ÿç®¡ç†
â”‚  â”œâ”€ ç”¨æˆ·ç®¡ç†
â”‚  â”œâ”€ è§’è‰²ç®¡ç†
â”‚  â”œâ”€ èœå•ç®¡ç†
â”‚  â””â”€ ç§Ÿæˆ·ç®¡ç†
â”œâ”€ ä¸šåŠ¡ç®¡ç†
â”‚  â”œâ”€ è®¢å•ç®¡ç†
â”‚  â””â”€ å•†å“ç®¡ç†
```

#### 2. **æƒé™é€šè¿‡è§’è‰²æ§åˆ¶**
```typescript
// ç§Ÿæˆ·Açš„ç®¡ç†å‘˜è§’è‰²
è§’è‰²ï¼šç§Ÿæˆ·Aç®¡ç†å‘˜
æƒé™ï¼šç³»ç»Ÿç®¡ç†ã€ä¸šåŠ¡ç®¡ç†ï¼ˆå…¨éƒ¨èœå•ï¼‰

// ç§Ÿæˆ·Açš„æ™®é€šå‘˜å·¥è§’è‰²
è§’è‰²ï¼šç§Ÿæˆ·Aå‘˜å·¥
æƒé™ï¼šä¸šåŠ¡ç®¡ç†ï¼ˆéƒ¨åˆ†èœå•ï¼‰

// ç§Ÿæˆ·Bçš„ç®¡ç†å‘˜è§’è‰²
è§’è‰²ï¼šç§Ÿæˆ·Bç®¡ç†å‘˜
æƒé™ï¼šç³»ç»Ÿç®¡ç†ã€ä¸šåŠ¡ç®¡ç†ï¼ˆå…¨éƒ¨èœå•ï¼‰
```

#### 3. **ä¼˜åŠ¿**

| ç»´åº¦ | èœå•å…±äº« | èœå•éš”ç¦» |
|------|---------|---------|
| **æ•°æ®é‡** | âœ… å°‘é‡ | âŒ å¤§é‡å†—ä½™ |
| **å‡çº§ç»´æŠ¤** | âœ… ä¸€æ¬¡å‡çº§ | âŒ éœ€è¿ç§»æ‰€æœ‰ç§Ÿæˆ· |
| **ç®¡ç†æˆæœ¬** | âœ… ä½ | âŒ é«˜ |
| **åŠŸèƒ½ä¸€è‡´æ€§** | âœ… ä¿è¯ç»Ÿä¸€ | âš ï¸ å¯èƒ½ä¸ä¸€è‡´ |
| **å®šåˆ¶èƒ½åŠ›** | âš ï¸ é€šè¿‡è§’è‰²å®ç° | âœ… æ¯ç§Ÿæˆ·ç‹¬ç«‹ |

---

## ğŸ’¡ æƒé™æ§åˆ¶æµç¨‹

### ç”¨æˆ·è®¿é—®èœå•çš„æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·ç™»å½•] --> B[è·å–ç”¨æˆ·è§’è‰²]
    B --> C{è§’è‰²æ˜¯å¦æœ‰æƒé™?}
    C -->|æ˜¯| D[æ˜¾ç¤ºèœå•]
    C -->|å¦| E[éšè—èœå•]
    
    style A fill:#e1f5ff
    style D fill:#d4edda
    style E fill:#f8d7da
```

### ç¤ºä¾‹ä»£ç 

```java
// 1. èœå•å®šä¹‰ï¼ˆæ‰€æœ‰ç§Ÿæˆ·å…±äº«ï¼‰
sys_menu:
  id: 1, name: "ç”¨æˆ·ç®¡ç†", perm: "sys:user:list"

// 2. ç§Ÿæˆ·Açš„è§’è‰²ï¼ˆç§Ÿæˆ·éš”ç¦»ï¼‰
sys_role (tenant_id=1):
  id: 10, name: "ç®¡ç†å‘˜", tenant_id: 1

// 3. è§’è‰²èœå•å…³è”ï¼ˆç§Ÿæˆ·éš”ç¦»ï¼‰
sys_role_menu (tenant_id=1):
  role_id: 10, menu_id: 1, tenant_id: 1
  
// æŸ¥è¯¢æ—¶è‡ªåŠ¨è¿‡æ»¤
SELECT t3.perm, t2.code 
FROM sys_role_menu t1
INNER JOIN sys_role t2 ON t1.role_id = t2.id 
  AND t2.tenant_id = 1  -- âœ… è§’è‰²ç§Ÿæˆ·è¿‡æ»¤
INNER JOIN sys_menu t3 ON t1.menu_id = t3.id
  -- âŒ èœå•ä¸éœ€è¦ç§Ÿæˆ·è¿‡æ»¤ï¼ˆé€šè¿‡ ignore-tables é…ç½®ï¼‰
WHERE t1.tenant_id = 1  -- âœ… å…³è”è¡¨ç§Ÿæˆ·è¿‡æ»¤
```

---

## ğŸ”§ é…ç½®ç¤ºä¾‹

### application-dev.yml

```yaml
youlai:
  tenant:
    # å¯ç”¨å¤šç§Ÿæˆ·
    enabled: true
    
    # ç§Ÿæˆ·å­—æ®µå
    column: tenant_id
    
    # é»˜è®¤ç§Ÿæˆ·ID
    default-tenant-id: 1
    
    # å¿½ç•¥å¤šç§Ÿæˆ·è¿‡æ»¤çš„è¡¨ï¼ˆé‡ç‚¹é…ç½®ï¼‰
    ignore-tables:
      - sys_tenant      # ç§Ÿæˆ·è¡¨æœ¬èº«
      - sys_menu        # èœå•è¡¨ï¼ˆæ‰€æœ‰ç§Ÿæˆ·å…±äº«ï¼‰
      - sys_dict        # å­—å…¸è¡¨
      - sys_dict_item   # å­—å…¸é¡¹è¡¨
      - sys_config      # ç³»ç»Ÿé…ç½®è¡¨
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: å¦‚æœéœ€è¦ä¸ºä¸åŒç§Ÿæˆ·å®šåˆ¶èœå•æ€ä¹ˆåŠï¼Ÿ

**A:** æœ‰ä¸¤ç§æ–¹æ¡ˆï¼š

#### æ–¹æ¡ˆ1: é€šè¿‡è§’è‰²æƒé™æ§åˆ¶ï¼ˆæ¨èï¼‰
```
ç§Ÿæˆ·Açœ‹åˆ°ï¼šèœå•Aã€Bã€Cï¼ˆé€šè¿‡è§’è‰²æƒé™é…ç½®ï¼‰
ç§Ÿæˆ·Bçœ‹åˆ°ï¼šèœå•Aã€Bï¼ˆé€šè¿‡è§’è‰²æƒé™é…ç½®ï¼‰
```

#### æ–¹æ¡ˆ2: èœå•éš”ç¦»ï¼ˆä¸æ¨èï¼‰
```yaml
# å°† sys_menu ä» ignore-tables ä¸­ç§»é™¤
ignore-tables:
  - sys_tenant
  # - sys_menu  # æ³¨é‡Šæ‰ï¼Œå¯ç”¨èœå•éš”ç¦»

# ç„¶åæ‰§è¡Œ SQL æ·»åŠ  tenant_id
ALTER TABLE sys_menu 
ADD COLUMN tenant_id bigint DEFAULT 1;
```

---

### Q2: å¦‚æœåç«¯æŠ¥é”™ `Unknown column 't3.tenant_id'` æ€ä¹ˆåŠï¼Ÿ

**A:** è¿™ä¸ªé”™è¯¯è¯´æ˜ï¼š
1. âŒ `sys_menu` è¡¨æ²¡æœ‰ `tenant_id` å­—æ®µ
2. âŒ ä½†é…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰å°† `sys_menu` æ·»åŠ åˆ° `ignore-tables`
3. âœ… è§£å†³æ–¹æ¡ˆï¼šå°† `sys_menu` æ·»åŠ åˆ° `ignore-tables`ï¼ˆæœ¬æ–‡æ¡£å·²è¯´æ˜ï¼‰

---

### Q3: å­—å…¸è¡¨éœ€è¦éš”ç¦»å—ï¼Ÿ

**A:** é€šå¸¸ä¸éœ€è¦ï¼ŒåŸå› ï¼š
- å­—å…¸æ˜¯ç³»ç»Ÿæ ‡å‡†é…ç½®ï¼ˆå¦‚ï¼šæ€§åˆ«ã€çŠ¶æ€ç­‰ï¼‰
- æ‰€æœ‰ç§Ÿæˆ·åº”è¯¥ä½¿ç”¨ç»Ÿä¸€çš„å­—å…¸å®šä¹‰
- å¦‚æœéœ€è¦ç§Ÿæˆ·çº§å­—å…¸ï¼Œå¯ä»¥å•ç‹¬åˆ›å»º `tenant_dict` è¡¨

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒåŸåˆ™

1. **æ•°æ®éš”ç¦»**ï¼šç”¨æˆ·ã€è§’è‰²ã€éƒ¨é—¨ç­‰ä¸šåŠ¡æ•°æ®å¿…é¡»éš”ç¦»
2. **åŠŸèƒ½å…±äº«**ï¼šèœå•ã€å­—å…¸ã€é…ç½®ç­‰ç³»ç»Ÿå®šä¹‰åº”è¯¥å…±äº«
3. **æƒé™æ§åˆ¶**ï¼šé€šè¿‡è§’è‰²å’Œæƒé™å®ç°è®¿é—®æ§åˆ¶

### æœ€ä½³å®è·µ

```
âœ… æ¨èåšæ³•ï¼š
- èœå•å®šä¹‰å…±äº«
- è§’è‰²ç§Ÿæˆ·éš”ç¦»
- é€šè¿‡è§’è‰²æ§åˆ¶èœå•è®¿é—®æƒé™

âŒ ä¸æ¨èåšæ³•ï¼š
- ä¸ºæ¯ä¸ªç§Ÿæˆ·å¤åˆ¶èœå•
- èœå•å’Œè§’è‰²éƒ½éš”ç¦»ä½†é€»è¾‘ç›¸åŒ
- å‡çº§æ—¶éœ€è¦è¿ç§»æ‰€æœ‰ç§Ÿæˆ·çš„èœå•
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [å¤šç§Ÿæˆ·ç”¨æˆ·ç®¡ç†æ”¹è¿›è¯´æ˜](./å¤šç§Ÿæˆ·ç”¨æˆ·ç®¡ç†æ”¹è¿›è¯´æ˜.md)
- [tenant_add.sql](../sql/mysql/tenant_add.sql) - å¤šç§Ÿæˆ·SQLè„šæœ¬
- [TenantProperties.java](../src/main/java/com/youlai/boot/config/property/TenantProperties.java) - é…ç½®ç±»

---

**æ›´æ–°æ—¶é—´**ï¼š2025-12-12
**ç‰ˆæœ¬**ï¼šv3.0.0
